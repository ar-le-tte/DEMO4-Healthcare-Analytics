Part 3.3 – Star Schema Queries (star_schema_queries.txt)
=======================================================

QUERY 1 (Star): Monthly Encounters by Specialty
------------------------------------------------------------
SQL Query:
SELECT d.year, d.month_number, d.month_name, s.specialty_name, et.encounter_type_name,
  COUNT(*) AS total_encounters,
  COUNT(DISTINCT f.patient_key) AS unique_patients
FROM fact_encounters f
JOIN dim_date d ON d.date_key = f.encounter_date_key
JOIN dim_specialty s ON s.specialty_key = f.specialty_key
JOIN dim_encounter_type et ON et.encounter_type_key = f.encounter_type_key
GROUP BY
  d.year, d.month_number, d.month_name, s.specialty_name, et.encounter_type_name
ORDER BY
  d.year, d.month_number, s.specialty_name, et.encounter_type_name;

Execution time estimate:
- Star schema: 11.009 ms
- OLTP schema: 32.795 ms

Improvement factor:
32.795 / 11.009 ≈ 2.98x faster

Why it’s faster:
- The fact table already contains the specialty_key and encounter_type_key, so we avoid the OLTP join chain encounters → providers → specialties.
- The added composite index on fact_encounters helps the planner handle grouping and the COUNT(DISTINCT patient_key) more efficiently, so less time is spent in the sort + aggregate phase.
- Joins are against small dimensions (25 specialties, 3 encounter types, ~731 dates) using integer keys, which keeps hash joins cheap.
- The main remaining cost is COUNT(DISTINCT ...) which still forces a sort, but the overall join work is reduced compared to OLTP.

QUERY 2 (Star): Top Diagnosis–Procedure Pairs
------------------------------------------------------------
SQL Query:
SELECT d.icd10_code, p.cpt_code, fp.encounter_count
FROM fact_diag_proc_pairs fp
JOIN dim_diagnosis d ON d.diagnosis_key = fp.diagnosis_key
JOIN dim_procedure p ON p.procedure_key = fp.procedure_key
ORDER BY fp.encounter_count DESC
LIMIT 20;

Execution time estimate:
- Star schema (with a pre-aggregated pairs table): 0.180 ms
- OLTP schema: 38.073 ms

Improvement factor:
38.073 / 0.180 ≈ 211.5x faster

Why it’s faster:
- Instead of joining two junction/bridge tables at query time (which creates a diagnosis_count × procedure_count row explosion per encounter), we precompute the diagnosis–procedure pair counts once into star.fact_diag_proc_pairs.
- The query becomes a simple lookup + small joins to two dimensions (dim_diagnosis and dim_procedure), followed by an ORDER BY on an already computed metric.
- This removes the expensive join-and-group work from the query path and makes performance essentially constant-time for reporting.

QUERY 3 (Star): 30-Day Readmission Rate by Specialty
------------------------------------------------------------
QUERY 3: 30-Day Readmission Rate (Star Schema)

SQL Query:
SELECT s.specialty_name,
  COUNT(DISTINCT f1.encounter_id) AS inpatient_discharges,
  COUNT(DISTINCT f1.encounter_id) FILTER (
    WHERE f2.fact_encounter_key IS NOT NULL
) AS readmissions, ROUND(COUNT(DISTINCT f1.encounter_id) FILTER (WHERE f2.fact_encounter_key IS NOT NULL)::numeric
    / NULLIF(COUNT(DISTINCT f1.encounter_id), 0),4) AS readmission_rate
FROM star.fact_encounters f1
JOIN star.dim_encounter_type et ON et.encounter_type_key = f1.encounter_type_key
JOIN star.dim_specialty s ON s.specialty_key = f1.specialty_key
LEFT JOIN LATERAL (SELECT f2.fact_encounter_key
  FROM star.fact_encounters f2
  WHERE f2.patient_key = f1.patient_key
    AND f2.encounter_date_key > f1.discharge_date_key
    AND f2.encounter_date_key <= (
      SELECT dc.date_key
      FROM star.dim_date dd
      JOIN star.dim_date dc ON dc.calendar_date = dd.calendar_date + INTERVAL '30 days'
      WHERE dd.date_key = f1.discharge_date_key)
  ORDER BY f2.encounter_date_key
  LIMIT 1) f2 ON TRUE
WHERE et.encounter_type_name = 'Inpatient'
  AND f1.discharge_date_key IS NOT NULL
GROUP BY s.specialty_name
ORDER BY readmission_rate DESC;

Execution time estimate:
- Star schema (optimized): 6.867 ms
- OLTP schema: 42.317 ms

Improvement factor:
42.317 / 6.867 ≈ 6.164x faster

Why it’s faster:
- The OLTP approach needs a heavy self-join on encounters plus a join chain to providers/specialties.
- The star schema keeps patient_key, specialty_key, encounter_date_key, and discharge_date_key directly in the fact table, so we avoid the OLTP join chain.
- Readmission detection is handled via an index-supported lookup on (patient_key, encounter_date_key), which avoids generating a huge self-join candidate set.
- The cutoff date (discharge + 30 days) is computed once and reused (memoized), reducing repeated work per inpatient discharge.